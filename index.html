<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible=IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>乌萨奇</title>
		<link rel="stylesheet" href="access/css/sweetalert2.min.css">
		<style>
			:root {
				--bg-color: #e0e5ec;
				--text-color: #333;
				--primary-color: #de2719;
				--glass-bg: rgba(255, 255, 255, 0.25);
				--shadow-light: 5px 5px 10px #b8b9be, -5px -5px 10px #ffffff;
				--shadow-inset: inset 2px 2px 5px #b8b9be, inset -2px -2px 5px #ffffff;
			}

			body {
				background-color: var(--bg-color);
				color: var(--text-color);
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				margin: 0;
				padding: 0;
			}

			#app {
				max-width: 600px;
				margin: 20px auto;
				padding: 20px;
				border-radius: 16px;
				background: var(--glass-bg);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				box-shadow: var(--shadow-light);
			}

			.img-view {
				border-radius: 16px;
				overflow: hidden;
				width: 100%;
				height: auto;
				box-shadow: var(--shadow-light);
				transition: transform 0.3s ease;
			}

			.img-view:hover {
				transform: scale(1.02);
			}

			.des {
				border-radius: 16px;
				padding: 15px 20px;
				margin-top: 15px;
				background: var(--glass-bg);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				box-shadow: var(--shadow-inset);
				color: var(--text-color);
			}

			.des ul {
				color: var(--text-color);
				width: 100%;
				margin: 0;
				padding: 0;
				line-height: 25px;
			}

			.install {
				display: flex;
				align-items: center;
				flex-direction: column;
				margin: 20px 0;
			}

			.button {
				padding: 15px;
				margin: 12px 0;
				border: none;
				width: 100%;
				border-radius: 50px;
				font-weight: bold;
				font-size: 1rem;
				color: var(--text-color);
				background: var(--bg-color);
				box-shadow: var(--shadow-light);
				transition: all 0.3s ease;
				cursor: pointer;
				outline: none;
			}

			.button:hover {
				box-shadow: var(--shadow-inset);
				color: var(--primary-color);
			}

			.button:active {
				box-shadow: var(--shadow-inset);
			}

			li, ul {
				list-style-type: none;
				font-weight: bold;
				font-size: 14px;
			}

			.des li:before {
				content: "🔸";
				margin-right: 8px;
			}

			.swal2-popup {
				border-radius: 16px !important;
				padding: 20px !important;
				background: var(--glass-bg) !important;
				backdrop-filter: blur(10px) !important;
				-webkit-backdrop-filter: blur(10px) !important;
				box-shadow: var(--shadow-light) !important;
			}

			.swal2-title {
				font-size: 18px !important;
				margin: 5px 0 !important;
				padding-top: 0 !important;
				color: var(--text-color) !important;
			}

			.swal2-html-container {
				font-size: 14px !important;
				margin: 5px 0 !important;
				color: var(--text-color) !important;
			}

			.swal2-input {
				font-size: 14px !important;
				padding: 12px !important;
				height: 40px !important;
				border-radius: 10px !important;
				background: var(--bg-color) !important;
				box-shadow: var(--shadow-inset) !important;
				border: none !important;
			}

			.swal2-confirm, .swal2-cancel {
				border-radius: 50px !important;
				padding: 10px 20px !important;
				background: var(--bg-color) !important;
				box-shadow: var(--shadow-light) !important;
				border: none !important;
				color: var(--text-color) !important;
			}

			.swal2-confirm:hover, .swal2-cancel:hover {
				box-shadow: var(--shadow-inset) !important;
			}

			.progress-bar {
				width: 100%;
				height: 8px;
				background-color: #d1d9e6;
				border-radius: 10px;
				overflow: hidden;
				margin-top: 15px;
				position: relative;
				box-shadow: var(--shadow-inset);
			}

			.progress-bar-inner {
				height: 100%;
				width: 0%;
				background-color: var(--primary-color);
				transition: width 0.2s linear;
				border-radius: 10px;
			}

			@media (max-width: 768px) {
				#app {
					max-width: 90%;
					padding: 15px;
					margin: 15px auto;
				}

				.button {
					width: 100%;
					padding: 12px;
				}

				.img-view {
					width: 100%;
				}

				.des {
					padding: 15px;
				}

				.swal2-popup {
					width: 90% !important;
					max-width: 90% !important;
				}
			}
		</style>
		<script src="sweetalert2@11"></script>
	</head>
	<body>
		<div id="app">
			<img class="img-view" src="access/images/banner.png" alt="底部图片">
			<div class="des">
				<ul>
					<li>完美转发 超级防封 畅爽使用</li>
					<li>一个激活码可在一个设备上 <span style="color: #05f384;">一开</span></li>
					<li>一个激活码不可用在其他设备</li>
					<li>一个激活码可以下载<span style="color: #05f384;">一次</span></li>
					<li><span style="color: #05f384;">一码一开，需要更多请使用多个激活码！</span></li>
					<li>安装界面过期时间与用户无关，请放心使用！</li>
				</ul>
			</div>

			<div class="install">
				<button class="button" onclick="installTf()">步骤一 →【安装 TestFlight】</button>
				<button class="button" onclick="redirectToLink()">步骤二 →【TF安装 乌萨奇】</button>
				<button class="button" onclick="redirectTobyLink()">备用安装地址</button>
				<button class="button" onclick="showQueryCodeModal()">兑换码查询</button>
			</div>

			<img class="img-view" src="access/images/9042a202502221500427831.png" alt="底部图片">
		</div>

		<script>
			// 判断是否为 iOS 设备
			function isIOSDevice() {
				return !!navigator.userAgent.match(/(iPhone|iPod|iPad)/i);
			}

			// 检查网络连接
			function isNetworkAvailable() {
				return navigator.onLine;
			}

			// 跳转安装 TestFlight
			function installTf() {
				window.open("https://apps.apple.com/cn/app/testflight/id899247664", "_blank");
			}

			// 激活兑换码逻辑
			async function showRedeemCodeModal() {
				if (!isNetworkAvailable()) {
					Swal.fire({
						title: '网络连接错误',
						text: '请检查您的网络连接并重试。',
						confirmButtonText: '知道了',
						confirmButtonColor: '#f44336',
					});
					return;
				}

				const {
					value: code
				} = await Swal.fire({
					title: '输入兑换码',
					input: 'text',
					inputPlaceholder: '请输入激活码',
					confirmButtonText: '激活',
					showCancelButton: true,
					cancelButtonText: '取消',
					confirmButtonColor: '#1b853e',
					cancelButtonColor: '#f44336',
				});

				if (code) {
					redeemCodeAPI(code);
				}
			}

			// 处理兑换码激活API请求
			async function redeemCodeAPI(code) {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000); // 设置超时为10秒

				const modal = Swal.fire({
					title: '激活中，请稍等...',
					html: `
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="redeemProgress"></div>
                    </div>
                    <p id="statusText" style="margin-top: 10px; font-size: 14px; color: #333;">正在获取链接中，请稍等... (0%)</p>
                `,
					showConfirmButton: false,
					allowOutsideClick: false,
					didOpen: async () => {
						const progressBar = document.getElementById('redeemProgress');
						const statusText = document.getElementById('statusText');
						let progress = 0;

						// 使用 setTimeout 逐步更新进度条
						function updateProgress() {
							if (progress < 100) {
								progress += 10;
								progressBar.style.width = `${progress}%`;
								statusText.textContent = `正在获取链接中，请稍等... (${progress}%)`;

								// 继续更新直到进度达到100%
								setTimeout(updateProgress, 300);
							} else {
								// 跳转逻辑
								statusText.textContent = `正在验证激活码，请稍等... (100%)`;
								proceedWithRedemption();
							}
						}


						// 启动进度条更新
						updateProgress();

						async function proceedWithRedemption() {
							try {
								const response = await fetch(
									`/redeem.php?action=redeem&code=${encodeURIComponent(code)}`, {
										signal: controller.signal
									});
								clearTimeout(timeoutId); // 清除超时计时器

								if (!response.ok) {
									throw new Error(`服务器错误：${response.status}`);
								}

								const result = await response.json();
								if (result.code === 1 && result.data?.url) {
									// 成功处理
									const redirectLink =
										`itms-beta://testflight.apple.com/v1/invite/${result.data.url}`;
									Swal.close(); // 关闭弹窗
									setTimeout(() => {
										if (isIOSDevice()) {
											window.location.href = redirectLink; // iOS 跳转
										} else {
											// 非 iOS 设备使用 `<a>` 标签模拟点击，防止浏览器拦截
											const a = document.createElement('a');
											a.href = redirectLink.replace('itms-beta://',
											'https://');
											a.target = '_blank';
											a.rel = 'noopener noreferrer';
											document.body.appendChild(a);
											a.click();
											document.body.removeChild(a);
										}
									}, 300); // 300ms 后跳转
								} else {
									statusText.textContent = `激活失败，请稍后重试。`;
									Swal.fire({
										title: '提示',
										text: result.msg || "未知错误", // 直接显示 API 返回的消息
										confirmButtonText: '知道了',
										confirmButtonColor: '#f44336',
									});
								}
							} catch (error) {
								clearTimeout(timeoutId);
								// 超时或请求失败
								statusText.textContent = `请求失败，请稍后重试。`;
								if (error.name === 'AbortError') {
									Swal.fire({
										title: '请求超时',
										text: '请求服务器的时间过长，请稍后重试。',
										confirmButtonText: '重试',
										confirmButtonColor: '#f44336',
									});
								} else {
									statusText.textContent = `请求失败，请稍后重试。`;
									Swal.fire({
										title: '网络错误',
										text: '发生了未知错误，请稍后重试。',
										confirmButtonText: '知道了',
										confirmButtonColor: '#f44336',
									});
								}
							}
						}
					},
				});
			}

			// 跳转备用安装地址
			function redirectToLink() {
				window.open("https://down.tf1888.xyz/#/redeem/WuSaQ", "_blank");
			}
			function redirectTobyLink() {
				window.open("http://192.140.190.106:99/#/redeem/WuSaQ", "_blank");
			}

			// 查询兑换码
			async function showQueryCodeModal() {
				if (!isNetworkAvailable()) {
					Swal.fire({
						title: '网络连接错误',
						text: '请检查您的网络连接并重试。',
						confirmButtonText: '知道了',
						confirmButtonColor: '#f44336',
					});
					return;
				}

				const {
					value: code
				} = await Swal.fire({
					title: '查询兑换码状态',
					input: 'text',
					inputPlaceholder: '请输入需要查询的激活码',
					confirmButtonText: '查询',
					showCancelButton: true,
					cancelButtonText: '取消',
					confirmButtonColor: '#1b853e',
					cancelButtonColor: '#f44336',
				});

				if (code) {
					queryCodeStatus(code);
				}
			}

			// 查询兑换码状态
			async function queryCodeStatus(code) {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000);

				const modal = Swal.fire({
					title: '查询中，请稍等...',
					html: `
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="queryProgress"></div>
                    </div>
                    <p id="queryStatusText" style="margin-top: 10px; font-size: 14px; color: #333;">正在查询兑换码状态，请稍等... (0%)</p>
                `,
					showConfirmButton: false,
					allowOutsideClick: false,
					didOpen: async () => {
						const progressBar = document.getElementById('queryProgress');
						const statusText = document.getElementById('queryStatusText');
						let progress = 0;

						const interval = setInterval(() => {
							progress += 20;
							progressBar.style.width = `${progress}%`;
							statusText.textContent = `正在查询兑换码状态，请稍等... (${progress}%)`;

							if (progress >= 100) {
								clearInterval(interval);
							}
						}, 500); // 每500ms更新一次进度

						try {
							const response = await fetch(`/redeem_query.php?code=${encodeURIComponent(code)}`, {
								signal: controller.signal
							});
							clearTimeout(timeoutId);

							const result = await response.json();
							if (result.code === 1) {
								const statusMessage = result.data.status === '已使用' ?
									`兑换时间：${result.data.redeem_time}` :
									'该兑换码未使用';
								statusText.textContent = `查询完成... (100%)`;
								Swal.fire({
									title: '查询完成',
									text: `兑换码状态：${statusMessage}`,
									confirmButtonText: '知道了',
									confirmButtonColor: '#28a412',
								});
							} else {
								statusText.textContent = `查询失败，请稍后重试。`;
								Swal.fire({
									title: '查询失败',
									text: result.msg || '激活码不存在',
									confirmButtonText: '知道了',
									confirmButtonColor: '#f44336',
								});
							}
						} catch (error) {
							clearTimeout(timeoutId);
							statusText.textContent = `请求失败，请稍后重试。`;
							Swal.fire({
								title: '网络错误',
								text: '无法连接到服务器，请稍后重试。',
								confirmButtonText: '知道了',
								confirmButtonColor: '#f44336',
							});
						}
					},
				});
			}
		</script>
	</body>

</html>
