<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible=IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>ä¹Œè¨å¥‡</title>
		<link rel="stylesheet" href="access/css/sweetalert2.min.css">
		<style>
			:root {
				--bg-color: #e0e5ec;
				--text-color: #333;
				--primary-color: #de2719;
				--glass-bg: rgba(255, 255, 255, 0.25);
				--shadow-light: 5px 5px 10px #b8b9be, -5px -5px 10px #ffffff;
				--shadow-inset: inset 2px 2px 5px #b8b9be, inset -2px -2px 5px #ffffff;
			}

			body {
				background-color: var(--bg-color);
				color: var(--text-color);
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				margin: 0;
				padding: 0;
			}

			#app {
				max-width: 600px;
				margin: 20px auto;
				padding: 20px;
				border-radius: 16px;
				background: var(--glass-bg);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				box-shadow: var(--shadow-light);
			}

			.img-view {
				border-radius: 16px;
				overflow: hidden;
				width: 100%;
				height: auto;
				box-shadow: var(--shadow-light);
				transition: transform 0.3s ease;
			}

			.img-view:hover {
				transform: scale(1.02);
			}

			.des {
				border-radius: 16px;
				padding: 15px 20px;
				margin-top: 15px;
				background: var(--glass-bg);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				box-shadow: var(--shadow-inset);
				color: var(--text-color);
			}

			.des ul {
				color: var(--text-color);
				width: 100%;
				margin: 0;
				padding: 0;
				line-height: 25px;
			}

			.install {
				display: flex;
				align-items: center;
				flex-direction: column;
				margin: 20px 0;
			}

			.button {
				padding: 15px;
				margin: 12px 0;
				border: none;
				width: 100%;
				border-radius: 50px;
				font-weight: bold;
				font-size: 1rem;
				color: var(--text-color);
				background: var(--bg-color);
				box-shadow: var(--shadow-light);
				transition: all 0.3s ease;
				cursor: pointer;
				outline: none;
			}

			.button:hover {
				box-shadow: var(--shadow-inset);
				color: var(--primary-color);
			}

			.button:active {
				box-shadow: var(--shadow-inset);
			}

			li, ul {
				list-style-type: none;
				font-weight: bold;
				font-size: 14px;
			}

			.des li:before {
				content: "ğŸ”¸";
				margin-right: 8px;
			}

			.swal2-popup {
				border-radius: 16px !important;
				padding: 20px !important;
				background: var(--glass-bg) !important;
				backdrop-filter: blur(10px) !important;
				-webkit-backdrop-filter: blur(10px) !important;
				box-shadow: var(--shadow-light) !important;
			}

			.swal2-title {
				font-size: 18px !important;
				margin: 5px 0 !important;
				padding-top: 0 !important;
				color: var(--text-color) !important;
			}

			.swal2-html-container {
				font-size: 14px !important;
				margin: 5px 0 !important;
				color: var(--text-color) !important;
			}

			.swal2-input {
				font-size: 14px !important;
				padding: 12px !important;
				height: 40px !important;
				border-radius: 10px !important;
				background: var(--bg-color) !important;
				box-shadow: var(--shadow-inset) !important;
				border: none !important;
			}

			.swal2-confirm, .swal2-cancel {
				border-radius: 50px !important;
				padding: 10px 20px !important;
				background: var(--bg-color) !important;
				box-shadow: var(--shadow-light) !important;
				border: none !important;
				color: var(--text-color) !important;
			}

			.swal2-confirm:hover, .swal2-cancel:hover {
				box-shadow: var(--shadow-inset) !important;
			}

			.progress-bar {
				width: 100%;
				height: 8px;
				background-color: #d1d9e6;
				border-radius: 10px;
				overflow: hidden;
				margin-top: 15px;
				position: relative;
				box-shadow: var(--shadow-inset);
			}

			.progress-bar-inner {
				height: 100%;
				width: 0%;
				background-color: var(--primary-color);
				transition: width 0.2s linear;
				border-radius: 10px;
			}

			@media (max-width: 768px) {
				#app {
					max-width: 90%;
					padding: 15px;
					margin: 15px auto;
				}

				.button {
					width: 100%;
					padding: 12px;
				}

				.img-view {
					width: 100%;
				}

				.des {
					padding: 15px;
				}

				.swal2-popup {
					width: 90% !important;
					max-width: 90% !important;
				}
			}
		</style>
		<script src="sweetalert2@11"></script>
	</head>
	<body>
		<div id="app">
			<img class="img-view" src="access/images/banner.png" alt="åº•éƒ¨å›¾ç‰‡">
			<div class="des">
				<ul>
					<li>å®Œç¾è½¬å‘ è¶…çº§é˜²å° ç•…çˆ½ä½¿ç”¨</li>
					<li>ä¸€ä¸ªæ¿€æ´»ç å¯åœ¨ä¸€ä¸ªè®¾å¤‡ä¸Š <span style="color: #05f384;">ä¸€å¼€</span></li>
					<li>ä¸€ä¸ªæ¿€æ´»ç ä¸å¯ç”¨åœ¨å…¶ä»–è®¾å¤‡</li>
					<li>ä¸€ä¸ªæ¿€æ´»ç å¯ä»¥ä¸‹è½½<span style="color: #05f384;">ä¸€æ¬¡</span></li>
					<li><span style="color: #05f384;">ä¸€ç ä¸€å¼€ï¼Œéœ€è¦æ›´å¤šè¯·ä½¿ç”¨å¤šä¸ªæ¿€æ´»ç ï¼</span></li>
					<li>å®‰è£…ç•Œé¢è¿‡æœŸæ—¶é—´ä¸ç”¨æˆ·æ— å…³ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ï¼</li>
				</ul>
			</div>

			<div class="install">
				<button class="button" onclick="installTf()">æ­¥éª¤ä¸€ â†’ã€å®‰è£… TestFlightã€‘</button>
				<button class="button" onclick="redirectToLink()">æ­¥éª¤äºŒ â†’ã€TFå®‰è£… ä¹Œè¨å¥‡ã€‘</button>
				<button class="button" onclick="redirectTobyLink()">å¤‡ç”¨å®‰è£…åœ°å€</button>
				<button class="button" onclick="showQueryCodeModal()">å…‘æ¢ç æŸ¥è¯¢</button>
			</div>

			<img class="img-view" src="access/images/9042a202502221500427831.png" alt="åº•éƒ¨å›¾ç‰‡">
		</div>

		<script>
			// åˆ¤æ–­æ˜¯å¦ä¸º iOS è®¾å¤‡
			function isIOSDevice() {
				return !!navigator.userAgent.match(/(iPhone|iPod|iPad)/i);
			}

			// æ£€æŸ¥ç½‘ç»œè¿æ¥
			function isNetworkAvailable() {
				return navigator.onLine;
			}

			// è·³è½¬å®‰è£… TestFlight
			function installTf() {
				window.open("https://apps.apple.com/cn/app/testflight/id899247664", "_blank");
			}

			// æ¿€æ´»å…‘æ¢ç é€»è¾‘
			async function showRedeemCodeModal() {
				if (!isNetworkAvailable()) {
					Swal.fire({
						title: 'ç½‘ç»œè¿æ¥é”™è¯¯',
						text: 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶é‡è¯•ã€‚',
						confirmButtonText: 'çŸ¥é“äº†',
						confirmButtonColor: '#f44336',
					});
					return;
				}

				const {
					value: code
				} = await Swal.fire({
					title: 'è¾“å…¥å…‘æ¢ç ',
					input: 'text',
					inputPlaceholder: 'è¯·è¾“å…¥æ¿€æ´»ç ',
					confirmButtonText: 'æ¿€æ´»',
					showCancelButton: true,
					cancelButtonText: 'å–æ¶ˆ',
					confirmButtonColor: '#1b853e',
					cancelButtonColor: '#f44336',
				});

				if (code) {
					redeemCodeAPI(code);
				}
			}

			// å¤„ç†å…‘æ¢ç æ¿€æ´»APIè¯·æ±‚
			async function redeemCodeAPI(code) {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000); // è®¾ç½®è¶…æ—¶ä¸º10ç§’

				const modal = Swal.fire({
					title: 'æ¿€æ´»ä¸­ï¼Œè¯·ç¨ç­‰...',
					html: `
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="redeemProgress"></div>
                    </div>
                    <p id="statusText" style="margin-top: 10px; font-size: 14px; color: #333;">æ­£åœ¨è·å–é“¾æ¥ä¸­ï¼Œè¯·ç¨ç­‰... (0%)</p>
                `,
					showConfirmButton: false,
					allowOutsideClick: false,
					didOpen: async () => {
						const progressBar = document.getElementById('redeemProgress');
						const statusText = document.getElementById('statusText');
						let progress = 0;

						// ä½¿ç”¨ setTimeout é€æ­¥æ›´æ–°è¿›åº¦æ¡
						function updateProgress() {
							if (progress < 100) {
								progress += 10;
								progressBar.style.width = `${progress}%`;
								statusText.textContent = `æ­£åœ¨è·å–é“¾æ¥ä¸­ï¼Œè¯·ç¨ç­‰... (${progress}%)`;

								// ç»§ç»­æ›´æ–°ç›´åˆ°è¿›åº¦è¾¾åˆ°100%
								setTimeout(updateProgress, 300);
							} else {
								// è·³è½¬é€»è¾‘
								statusText.textContent = `æ­£åœ¨éªŒè¯æ¿€æ´»ç ï¼Œè¯·ç¨ç­‰... (100%)`;
								proceedWithRedemption();
							}
						}


						// å¯åŠ¨è¿›åº¦æ¡æ›´æ–°
						updateProgress();

						async function proceedWithRedemption() {
							try {
								const response = await fetch(
									`/redeem.php?action=redeem&code=${encodeURIComponent(code)}`, {
										signal: controller.signal
									});
								clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨

								if (!response.ok) {
									throw new Error(`æœåŠ¡å™¨é”™è¯¯ï¼š${response.status}`);
								}

								const result = await response.json();
								if (result.code === 1 && result.data?.url) {
									// æˆåŠŸå¤„ç†
									const redirectLink =
										`itms-beta://testflight.apple.com/v1/invite/${result.data.url}`;
									Swal.close(); // å…³é—­å¼¹çª—
									setTimeout(() => {
										if (isIOSDevice()) {
											window.location.href = redirectLink; // iOS è·³è½¬
										} else {
											// é iOS è®¾å¤‡ä½¿ç”¨ `<a>` æ ‡ç­¾æ¨¡æ‹Ÿç‚¹å‡»ï¼Œé˜²æ­¢æµè§ˆå™¨æ‹¦æˆª
											const a = document.createElement('a');
											a.href = redirectLink.replace('itms-beta://',
											'https://');
											a.target = '_blank';
											a.rel = 'noopener noreferrer';
											document.body.appendChild(a);
											a.click();
											document.body.removeChild(a);
										}
									}, 300); // 300ms åè·³è½¬
								} else {
									statusText.textContent = `æ¿€æ´»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
									Swal.fire({
										title: 'æç¤º',
										text: result.msg || "æœªçŸ¥é”™è¯¯", // ç›´æ¥æ˜¾ç¤º API è¿”å›çš„æ¶ˆæ¯
										confirmButtonText: 'çŸ¥é“äº†',
										confirmButtonColor: '#f44336',
									});
								}
							} catch (error) {
								clearTimeout(timeoutId);
								// è¶…æ—¶æˆ–è¯·æ±‚å¤±è´¥
								statusText.textContent = `è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
								if (error.name === 'AbortError') {
									Swal.fire({
										title: 'è¯·æ±‚è¶…æ—¶',
										text: 'è¯·æ±‚æœåŠ¡å™¨çš„æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•ã€‚',
										confirmButtonText: 'é‡è¯•',
										confirmButtonColor: '#f44336',
									});
								} else {
									statusText.textContent = `è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
									Swal.fire({
										title: 'ç½‘ç»œé”™è¯¯',
										text: 'å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚',
										confirmButtonText: 'çŸ¥é“äº†',
										confirmButtonColor: '#f44336',
									});
								}
							}
						}
					},
				});
			}

			// è·³è½¬å¤‡ç”¨å®‰è£…åœ°å€
			function redirectToLink() {
				window.open("https://down.tf1888.xyz/#/redeem/WuSaQ", "_blank");
			}
			function redirectTobyLink() {
				window.open("http://192.140.190.106:99/#/redeem/WuSaQ", "_blank");
			}

			// æŸ¥è¯¢å…‘æ¢ç 
			async function showQueryCodeModal() {
				if (!isNetworkAvailable()) {
					Swal.fire({
						title: 'ç½‘ç»œè¿æ¥é”™è¯¯',
						text: 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶é‡è¯•ã€‚',
						confirmButtonText: 'çŸ¥é“äº†',
						confirmButtonColor: '#f44336',
					});
					return;
				}

				const {
					value: code
				} = await Swal.fire({
					title: 'æŸ¥è¯¢å…‘æ¢ç çŠ¶æ€',
					input: 'text',
					inputPlaceholder: 'è¯·è¾“å…¥éœ€è¦æŸ¥è¯¢çš„æ¿€æ´»ç ',
					confirmButtonText: 'æŸ¥è¯¢',
					showCancelButton: true,
					cancelButtonText: 'å–æ¶ˆ',
					confirmButtonColor: '#1b853e',
					cancelButtonColor: '#f44336',
				});

				if (code) {
					queryCodeStatus(code);
				}
			}

			// æŸ¥è¯¢å…‘æ¢ç çŠ¶æ€
			async function queryCodeStatus(code) {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000);

				const modal = Swal.fire({
					title: 'æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨ç­‰...',
					html: `
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="queryProgress"></div>
                    </div>
                    <p id="queryStatusText" style="margin-top: 10px; font-size: 14px; color: #333;">æ­£åœ¨æŸ¥è¯¢å…‘æ¢ç çŠ¶æ€ï¼Œè¯·ç¨ç­‰... (0%)</p>
                `,
					showConfirmButton: false,
					allowOutsideClick: false,
					didOpen: async () => {
						const progressBar = document.getElementById('queryProgress');
						const statusText = document.getElementById('queryStatusText');
						let progress = 0;

						const interval = setInterval(() => {
							progress += 20;
							progressBar.style.width = `${progress}%`;
							statusText.textContent = `æ­£åœ¨æŸ¥è¯¢å…‘æ¢ç çŠ¶æ€ï¼Œè¯·ç¨ç­‰... (${progress}%)`;

							if (progress >= 100) {
								clearInterval(interval);
							}
						}, 500); // æ¯500msæ›´æ–°ä¸€æ¬¡è¿›åº¦

						try {
							const response = await fetch(`/redeem_query.php?code=${encodeURIComponent(code)}`, {
								signal: controller.signal
							});
							clearTimeout(timeoutId);

							const result = await response.json();
							if (result.code === 1) {
								const statusMessage = result.data.status === 'å·²ä½¿ç”¨' ?
									`å…‘æ¢æ—¶é—´ï¼š${result.data.redeem_time}` :
									'è¯¥å…‘æ¢ç æœªä½¿ç”¨';
								statusText.textContent = `æŸ¥è¯¢å®Œæˆ... (100%)`;
								Swal.fire({
									title: 'æŸ¥è¯¢å®Œæˆ',
									text: `å…‘æ¢ç çŠ¶æ€ï¼š${statusMessage}`,
									confirmButtonText: 'çŸ¥é“äº†',
									confirmButtonColor: '#28a412',
								});
							} else {
								statusText.textContent = `æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
								Swal.fire({
									title: 'æŸ¥è¯¢å¤±è´¥',
									text: result.msg || 'æ¿€æ´»ç ä¸å­˜åœ¨',
									confirmButtonText: 'çŸ¥é“äº†',
									confirmButtonColor: '#f44336',
								});
							}
						} catch (error) {
							clearTimeout(timeoutId);
							statusText.textContent = `è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
							Swal.fire({
								title: 'ç½‘ç»œé”™è¯¯',
								text: 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•ã€‚',
								confirmButtonText: 'çŸ¥é“äº†',
								confirmButtonColor: '#f44336',
							});
						}
					},
				});
			}
		</script>
	</body>

</html>
